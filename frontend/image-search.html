<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://accounts.google.com/gsi/client" async defer></script>
<title>Search by Image - VASTR</title>

<style>
/* ========== GENERAL RESET & BODY ========== */
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
    background:#fff; color:#000; line-height:1.5;
}

/* ========== NAVIGATION HEADER ========== */
nav {
    background: #fff;
    padding: 1rem 5%;
    border-bottom: 1px solid #e8e8e8;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
    gap: 2rem;
}

.logo { font-size:1.8rem; font-weight:700; color:#000; text-decoration:none; letter-spacing:-1px; white-space:nowrap; }
.nav-center { display:flex; gap:2rem; align-items:center; flex:1; }
.nav-links { display:flex; gap:2rem; white-space:nowrap; }
.nav-links a { text-decoration:none; color:#000; font-size:0.85rem; font-weight:500; transition:opacity 0.2s; }
.nav-links a:hover { opacity:0.6; }
.nav-search { flex:1; max-width:400px; position:relative; }
.nav-search-input {
    width:100%; padding:0.6rem 2.5rem 0.6rem 1rem; border:1px solid #e8e8e8; background:#f8f8f8; font-size:0.85rem;
    font-family:inherit; transition:all 0.2s; border-radius: 8px;
}
.nav-search-input:focus { outline:none; background:#fff; border-color:#000; }
.nav-search-icon { position:absolute; right:1rem; top:50%; transform:translateY(-50%); width:16px; height:16px; cursor:pointer; }
.nav-right { display:flex; gap:1.5rem; align-items:center; }
.nav-icon { cursor:pointer; width:20px; height:20px; background:none; border:none; padding:0; transition:opacity 0.2s; position: relative; }
.nav-icon svg { width:100%; height:100%; stroke:#000; fill:none; stroke-width:2; }
.nav-icon:hover { opacity:0.6; }

/* Wishlist count badge */
.wishlist-count {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #e74a3b;
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 10px;
    min-width: 18px;
    text-align: center;
    display: none;
}

/* Profile dropdown */
.profile-dropdown { position:relative; }
.profile-dropdown.active .profile-menu { display:block; }
.profile-menu {
  position:absolute; top:100%; right:0; background:#fff; border:1px solid #e8e8e8; border-radius:8px;
  min-width:200px; box-shadow:0 8px 24px rgba(0,0,0,0.12); z-index:1002; display:none; overflow:hidden;
  margin-top: 8px;
}
.profile-menu-item { padding:0.75rem 1rem; display:flex; align-items:center; gap:0.75rem; color:#000; text-decoration:none; font-size:0.9rem; transition:background 0.2s; border-bottom:1px solid #f5f5f5; }
.profile-menu-item:last-child { border-bottom:none; }
.profile-menu-item:hover { background:#f8f8f8; }
.profile-menu-item svg { width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2; }
.profile-user-info { padding:1rem; border-bottom:1px solid #f5f5f8; background:#fafafa; display:none; }
.profile-avatar { width:40px; height:40px; border-radius:50%; background:#000; color:#fff; display:flex; align-items:center; justify-content:center; font-size:0.85rem; font-weight:600; margin-right:0.75rem; }
.profile-user-details { flex:1; }
.profile-user-name { font-weight:600; font-size:0.9rem; margin-bottom:0.25rem; }
.profile-user-email { font-size:0.8rem; color:#666; }
.profile-logout { color:#e74a3b !important; }
.profile-logout:hover { background:#fef2f2; }
.nav-icon.profile-dropdown:hover { opacity:1 !important; }
.user-indicator { position:absolute; top:-4px; right:-4px; width:12px; height:12px; background:#10b981; border:2px solid #fff; border-radius:50%; display:none; }
.user-indicator.active { display:block; }

/* Search suggestions */
.search-suggestions { position:absolute; top:100%; left:0; right:0; background:#fff; border:1px solid #e8e8e8; border-top:none; max-height:300px; overflow-y:auto; display:none; z-index:1001; box-shadow:0 4px 12px rgba(0,0,0,0.1); border-radius: 0 0 8px 8px; }
.search-suggestions.active { display:block; }
.suggestion-item { padding:0.75rem 1rem; cursor:pointer; display:flex; align-items:center; gap:0.75rem; border-bottom:1px solid #f5f5f5; transition:background 0.2s; }
.suggestion-item:hover { background:#f8f8f8; }
.suggestion-icon { width:16px; height:16px; opacity:0.4; }
.suggestion-text { font-size:0.85rem; color:#000; }

/* ========== AUTH MODAL ========== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    padding: 2.5rem;
    border-radius: 12px;
    max-width: 450px;
    width: 90%;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
}

.modal-close:hover {
    background: #f5f5f5;
}

.modal-content h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    text-align: center;
}

.auth-form {
    margin: 1.5rem 0;
}

.auth-form input {
    width: 100%;
    padding: 0.875rem;
    border: 1px solid #e8e8e8;
    border-radius: 8px;
    font-size: 0.95rem;
    font-family: inherit;
    margin-bottom: 1rem;
}

.auth-form input:focus {
    outline: none;
    border-color: #000;
}

.auth-form button {
    width: 100%;
    padding: 0.875rem;
    background: #000;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.auth-form button:hover {
    background: #333;
}

.auth-divider {
    text-align: center;
    margin: 1.5rem 0;
    color: #999;
    font-size: 0.85rem;
    position: relative;
}

.auth-divider::before,
.auth-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: #e8e8e8;
}

.auth-divider::before {
    left: 0;
}

.auth-divider::after {
    right: 0;
}

#googleSignInButton {
    display: flex;
    justify-content: center;
}

/* ========== HERO & UPLOAD ========== */
.hero { text-align:center; padding:4rem 2rem; }
.hero h1 { font-size:2rem; margin-bottom:0.5rem; font-weight:600; }
.hero p { font-size:1rem; color:#555; max-width:600px; margin:0 auto; }

.upload-box {
    max-width:500px; margin:2rem auto; padding:3rem;
    border:2px dashed #ccc; border-radius:15px; background:#fff;
    text-align:center; cursor:pointer; transition:all .3s; box-shadow:0 5px 15px rgba(0,0,0,0.05);
}
.upload-box:hover, .upload-box.dragover { border-color:#000; background:#f0f0f0; }
.upload-icon { width:60px; height:60px; margin:0 auto 1rem; opacity:0.6; }
.upload-box h2 { font-size:1.3rem; margin-bottom:0.3rem; }
.upload-box p { color:#666; font-size:0.9rem; }
.btn-choose { background:#000; color:#fff; border:none; padding:0.8rem 2rem; border-radius:8px; font-size:0.9rem; margin-top:1rem; cursor:pointer; }

.preview { display:none; max-width:500px; margin:2rem auto; padding:0; text-align:center; }
.preview.active { display:block; }
.preview img { max-width:100%; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }

.actions { margin-top:1rem; display:flex; justify-content:center; gap:1rem; }
.actions button { flex:1; padding:0.8rem; border:none; border-radius:8px; cursor:pointer; font-size:0.9rem; transition:0.3s; }
.btn-search { background:#000; color:#fff; }
.btn-again { background:#666; color:#fff; }

.spinner { border:3px solid #f0f0f0; border-top:3px solid #000; border-radius:50%; width:16px; height:16px; animation:spin 1s linear infinite; display:inline-block; margin-right:5px; }
@keyframes spin { to { transform:rotate(360deg); } }

/* Notification animations */
@keyframes slideUp {
    from {
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

@keyframes slideDown {
    from {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
    to {
        transform: translateX(-50%) translateY(20px);
        opacity: 0;
    }
}

/* ========== AUTH MODAL ========== */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    padding: 2.5rem;
    border-radius: 12px;
    max-width: 450px;
    width: 90%;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
}

.modal-close:hover {
    background: #f5f5f5;
}

.modal-content h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
    text-align: center;
}

.auth-form {
    margin: 1.5rem 0;
}

.auth-form input {
    width: 100%;
    padding: 0.875rem;
    border: 1px solid #e8e8e8;
    border-radius: 8px;
    font-size: 0.95rem;
    font-family: inherit;
    margin-bottom: 1rem;
}

.auth-form input:focus {
    outline: none;
    border-color: #000;
}

.auth-form button {
    width: 100%;
    padding: 0.875rem;
    background: #000;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}

.auth-form button:hover {
    background: #333;
}

.auth-divider {
    text-align: center;
    margin: 1.5rem 0;
    color: #999;
    font-size: 0.85rem;
    position: relative;
}

.auth-divider::before,
.auth-divider::after {
    content: '';
    position: absolute;
    top: 50%;
    width: 40%;
    height: 1px;
    background: #e8e8e8;
}

.auth-divider::before {
    left: 0;
}

.auth-divider::after {
    right: 0;
}

#googleSignInButton {
    display: flex;
    justify-content: center;
}

.results { max-width:900px; margin:3rem auto; padding: 0 1rem; display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1.5rem; }
.product-card { border:1px solid #eee; border-radius:12px; padding:1rem; text-align:center; background:#fff; transition:0.3s; }
.product-card:hover { box-shadow:0 8px 20px rgba(0,0,0,0.08); }
.product-card img { max-width:100%; border-radius:8px; }
.product-title { font-size:0.9rem; margin:0.5rem 0; font-weight:500; }
.product-price { color:#000; font-weight:600; margin-bottom:0.5rem; }
.product-link { text-decoration:none; color:#fff; background:#000; padding:0.4rem 0.8rem; border-radius:6px; display:inline-block; font-size:0.8rem; }
.main-label { font-weight:600; margin-bottom:0.3rem; font-size:0.8rem; }
</style>
</head>
<body>

<!-- ===== HEADER NAV ===== -->
   <!-- Navigation -->
    <nav>
    <a href="home.html" class="logo">VASTR</a>

    <div class="nav-center">
        <div class="nav-links">
            <a href="#women">WOMEN</a>
            <a href="#brands">BRANDS</a>
            <a href="#sale">SALE</a>
        </div>

        <div class="nav-search">
            <input type="text" class="nav-search-input" id="navSearchInput"
                   placeholder="Search products, brands...">
            <svg class="nav-search-icon" onclick="performSearch()" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
    </div>

    <!-- MOVED OUTSIDE nav-center - NOW IN CORNER -->
    <div class="nav-right">
        <button class="nav-icon" title="Wishlist" onclick="handleWishlistClick()">
            <svg viewBox="0 0 24 24">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
            </svg>
            <span class="wishlist-count">0</span>
        </button>

        <div class="nav-icon profile-icon profile-dropdown" title="Account" id="profileDropdown">
            <svg viewBox="0 0 24 24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <div class="user-indicator" id="userIndicator"></div>

          <!-- Profile Dropdown Menu -->
            <div class="profile-menu" id="profileMenu">
                <div class="profile-user-info" id="profileUserInfo" style="display: none;">
                    <div style="display: flex; align-items: center;">
                        <div class="profile-avatar" id="profileAvatar"></div>
                        <div class="profile-user-details">
                            <div class="profile-user-name" id="profileUserName"></div>
                            <div class="profile-user-email" id="profileUserEmail"></div>
                        </div>
                    </div>
                </div>
                <a href="#" class="profile-menu-item" onclick="showAccountSettings(event)">
                    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6M5.64 5.64l4.24 4.24m4.24 4.24l4.24 4.24M1 12h6m6 0h6M5.64 18.36l4.24-4.24m4.24-4.24l4.24-4.24"/></svg>
                    <span>Account Settings</span>
                </a>
                <a href="#" class="profile-menu-item profile-logout" onclick="logout(event)">
                    <svg viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    <span>Log out</span>
                </a>
            </div>
        </div>

          <button class="nav-icon" title="Search by Image" onclick="window.location.href='image-search.html'">
    <svg viewBox="0 0 24 24">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21 15 16 10 5 21"></polyline>
    </svg>
</button>
    </div>
</nav>

<!-- ===== HERO ===== -->
<div class="hero">
    <h1>Find Similar Outfits Instantly</h1>
    <p>Upload a photo of any outfit â€” weâ€™ll show you the most similar product plus other options from top Pakistani brands.</p>
</div>

<!-- ===== UPLOAD BOX ===== -->
<div class="upload-box" id="uploadBox">
    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
    <h2>Drag & drop your image</h2>
    <p>or click to browse â€¢ JPG, PNG, up to 10MB</p>
    <button class="btn-choose">Choose Image</button>
    <input type="file" id="fileInput" accept="image/*" style="display:none">
</div>

<!-- ===== PREVIEW ===== -->
<div class="preview" id="preview">
    <img id="previewImg" src="" alt="Uploaded Image">
    <div class="actions">
        <button class="btn-search" id="searchBtn"><span id="btnText">Search Similar Products</span></button>
        <button class="btn-again" onclick="resetAll()">Upload Another Image</button>
    </div>
</div>

<!-- ===== RESULTS ===== -->
<div class="results" id="results"></div>

<script>
    const API_BASE = 'https://maha1326-vastr-fashion-api.hf.space/api/v1';
    let searchTimeout;
const uploadBox = document.getElementById('uploadBox');
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const resultsDiv = document.getElementById('results');
let file = null;

uploadBox.onclick = () => fileInput.click();
fileInput.onchange = e => { if(e.target.files[0]) loadImage(e.target.files[0]); }

['dragenter','dragover'].forEach(ev => uploadBox.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); uploadBox.classList.add('dragover'); }));
['dragleave','drop'].forEach(ev => uploadBox.addEventListener(ev,e=>{ e.preventDefault(); e.stopPropagation(); uploadBox.classList.remove('dragover'); }));
uploadBox.addEventListener('drop', e => { const f = e.dataTransfer.files[0]; if(f && f.type.startsWith('image/')) loadImage(f); });

function loadImage(f){
    file=f;
    const reader=new FileReader();
    reader.onload=e=>{ previewImg.src=e.target.result; preview.classList.add('active'); uploadBox.style.display='none'; window.scrollTo({top: preview.offsetTop-100, behavior:'smooth'}); }
    reader.readAsDataURL(f);
}

document.getElementById('searchBtn').onclick=async()=>{
    if(!file) return alert("Please upload an image first.");
    const btn=document.getElementById('searchBtn'), txt=document.getElementById('btnText');
    btn.disabled=true; txt.innerHTML='<div class="spinner"></div> Searching...';
    try {
        const b64=await new Promise((resolve,reject)=>{
            const r=new FileReader();
            r.onload=()=>resolve(r.result.split(',')[1]);
            r.onerror=err=>reject(err);
            r.readAsDataURL(file);
        });
        // FIXED: Use API_BASE instead of hardcoded localhost
        const res=await fetch(`${API_BASE}/search/image`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({image:b64, limit:10})
        });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data=await res.json();
        displayResults(data.results||data);
    } catch(err){ 
        alert('Backend error or offline. Check console.'); 
        console.error(err); 
    }
    finally{ btn.disabled=false; txt.textContent='Search Similar Products'; }
};
function displayResults(products){
    resultsDiv.innerHTML='';
    if(!products || products.length===0){
        resultsDiv.innerHTML='<p>No similar products found.</p>';
        return;
    }

    // Simple direct image with fallback (matching your friend's working version)
    const getImageUrl = (url) => {
        return url || 'https://via.placeholder.com/400x600/f5f5f5/999999?text=No+Image';
    };

    // Most Similar card
    const main = products[0];
    const mainCard = document.createElement('div');
    mainCard.className = 'product-card';
    mainCard.innerHTML = `
        <p class="main-label">Most Similar</p>
        <img src="${getImageUrl(main.image)}" alt="${main.name}" loading="lazy" crossorigin="anonymous">
        <p class="product-title">${main.name}</p>
        <p class="product-price">PKR ${main.price}</p>
        <a href="${main.link}" target="_blank" class="product-link">View Product</a>
    `;
    resultsDiv.appendChild(mainCard);

    // Other Options
    for(let i = 1; i < products.length; i++){
        const p = products[i];
        const card = document.createElement('div');
        card.className = 'product-card';
        card.innerHTML = `
            <p class="main-label">Other Options</p>
            <img src="${getImageUrl(p.image)}" alt="${p.name}" loading="lazy" crossorigin="anonymous">
            <p class="product-title">${p.name}</p>
            <p class="product-price">PKR ${p.price}</p>
            <a href="${p.link}" target="_blank" class="product-link">View Product</a>
        `;
        resultsDiv.appendChild(card);
    }
}
function resetAll(){ file=null; preview.classList.remove('active'); uploadBox.style.display='block'; resultsDiv.innerHTML=''; }
async function loadSearchSuggestions(query) {
    if (!query || query.length < 2) {
        document.getElementById('searchSuggestions').classList.remove('active');
        return;
    }

    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(async () => {
        try {
            const response = await fetch(`${API_BASE}/search/suggestions?q=${encodeURIComponent(query)}&limit=5`);
            const data = await response.json();

            const suggestionsDiv = document.getElementById('searchSuggestions');

            if (data.suggestions && data.suggestions.length > 0) {
                suggestionsDiv.innerHTML = data.suggestions.map(suggestion => `
                    <div class="suggestion-item" onclick="selectSuggestion('${suggestion.replace(/'/g, "\\'")}')">
                        <svg class="suggestion-icon" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8" stroke="currentColor" fill="none" stroke-width="2"></circle>
                            <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2"></path>
                        </svg>
                        <span class="suggestion-text">${suggestion}</span>
                    </div>
                `).join('');
                suggestionsDiv.classList.add('active');
            } else {
                suggestionsDiv.classList.remove('active');
            }
        } catch (error) {
            console.error('Suggestions error:', error);
        }
    }, 300);
}

function selectSuggestion(suggestion) {
    document.getElementById('navSearchInput').value = suggestion;
    document.getElementById('searchSuggestions').classList.remove('active');
    performSearch();
}

// CHANGE THIS FUNCTION:
function performSearch() {
    const query = document.getElementById('navSearchInput').value.trim();
    if (query) {
        window.location.href = `products.html?q=${encodeURIComponent(query)}`;
    }
}
            // ==================== WISHLIST FUNCTIONALITY ====================

function getWishlist() {
    // Only return wishlist if user is logged in
    if (!isLoggedIn()) {
        return [];
    }

    const wishlist = localStorage.getItem('vastr_wishlist');
    return wishlist ? JSON.parse(wishlist) : [];
}

function saveWishlist(wishlist) {
    localStorage.setItem('vastr_wishlist', JSON.stringify(wishlist));
    updateWishlistCount();
}

function isInWishlist(productId) {
    const wishlist = getWishlist();
    return wishlist.some(item => item.id === productId);
}

function toggleWishlist(product) {
    if (!isLoggedIn()) {
        showAuthModal();
        return;
    }

    let wishlist = getWishlist();

    if (isInWishlist(product.id)) {
        wishlist = wishlist.filter(item => item.id !== product.id);
        saveWishlist(wishlist);
        showNotification('Removed from wishlist');
    } else {
        wishlist.push(product);
        saveWishlist(wishlist);
        showNotification('Added to wishlist!');
    }

    updateHeartIcons();
}

function updateWishlistCount() {
    const wishlist = getWishlist();
    const countElements = document.querySelectorAll('.wishlist-count');
    countElements.forEach(el => {
        el.textContent = wishlist.length;
        el.style.display = wishlist.length > 0 ? 'block' : 'none';
    });
}

function updateHeartIcons() {
    document.querySelectorAll('.product-heart').forEach(heart => {
        const productId = heart.getAttribute('data-product-id');
        if (isInWishlist(productId)) {
            heart.classList.add('active');
        } else {
            heart.classList.remove('active');
        }
    });
}

function showNotification(message) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: #000;
        color: #fff;
        padding: 1rem 2rem;
        border-radius: 4px;
        z-index: 10000;
        font-size: 0.9rem;
        animation: slideUp 0.3s ease;
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.animation = 'slideDown 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

function showAuthModal() {
    if (!document.getElementById('authModal')) {
        createAuthModal();
    }
    document.getElementById('authModal').classList.add('active');
}

function closeAuthModal() {
    const modal = document.getElementById('authModal');
    if (modal) modal.classList.remove('active');
}
// ==================== AUTHENTICATION FUNCTIONALITY ====================

// Check if user is logged in
function isLoggedIn() {
    return localStorage.getItem('vastr_user') !== null;
}

// Get user data
function getUserData() {
    const userData = localStorage.getItem('vastr_user');
    return userData ? JSON.parse(userData) : null;
}

// Check if this is user's first login
function isFirstTimeLogin(email) {
    const loginHistory = localStorage.getItem('vastr_login_history');
    if (!loginHistory) {
        return true;
    }
    const history = JSON.parse(loginHistory);
    return !history.includes(email);
}

// Mark user as having logged in before
function markUserLogin(email) {
    const loginHistory = localStorage.getItem('vastr_login_history');
    let history = loginHistory ? JSON.parse(loginHistory) : [];
    if (!history.includes(email)) {
        history.push(email);
        localStorage.setItem('vastr_login_history', JSON.stringify(history));
    }
}

// Handle Google Sign-In response
async function handleGoogleResponse(response) {
    try {
        const userInfo = parseJwt(response.credential);
        const isFirstTime = isFirstTimeLogin(userInfo.email);

        const userData = {
            email: userInfo.email,
            name: userInfo.name,
            picture: userInfo.picture,
            provider: 'google',
            loginTime: new Date().toISOString(),
            isFirstLogin: isFirstTime
        };

        localStorage.setItem('vastr_user', JSON.stringify(userData));

        // Send welcome email only for first-time users
        if (isFirstTime) {
            try {
                console.log('ðŸ“§ Sending welcome email to first-time user...');
                const emailResponse = await fetch(`${API_BASE}/auth/welcome-email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: userInfo.email,
                        name: userInfo.name,
                        website_url: window.location.origin
                    })
                });

                const emailData = await emailResponse.json();

                if (emailResponse.ok) {
                    console.log('âœ… Welcome email sent successfully!');
                    showNotification(`Welcome, ${userInfo.name}! Check your email for a special message.`);
                } else {
                    console.warn('âš ï¸ Email sending failed:', emailData);
                    showNotification(`Welcome, ${userInfo.name}!`);
                }
            } catch (emailError) {
                console.error('âŒ Email API error:', emailError);
                // Don't fail the login if email fails
                showNotification(`Welcome, ${userInfo.name}!`);
            }

            // Mark this user as having logged in
            markUserLogin(userInfo.email);
        } else {
            console.log('ðŸ‘‹ Returning user - no welcome email needed');
            showNotification(`Welcome back, ${userInfo.name}!`);
        }

        closeAuthModal();
        updateProfileUI();
        updateWishlistCount();

        // Handle redirects
        const redirect = localStorage.getItem('redirect_after_login');
        if (redirect) {
            localStorage.removeItem('redirect_after_login');
            if (redirect === 'wishlist.html') {
                window.location.href = 'wishlist.html';
            }
        }

    } catch (error) {
        console.error('âŒ Google login error:', error);
        showNotification('Login failed. Please try again.');
    }
}

// Decode JWT token
function parseJwt(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(
        atob(base64).split('').map(c =>
            '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
        ).join('')
    );
    return JSON.parse(jsonPayload);
}

// Initialize Google Sign-In
function initializeGoogleSignIn() {
    if (typeof google !== 'undefined' && google.accounts) {
        google.accounts.id.initialize({
            client_id: '615669861278-4tr31uve6b956lr7ok80993h5cpisevp.apps.googleusercontent.com',
            callback: handleGoogleResponse,
            auto_select: false,
            cancel_on_tap_outside: false
        });

        google.accounts.id.renderButton(
            document.getElementById('googleSignInButton'),
            {
                theme: 'outline',
                size: 'large',
                width: 380,
                text: 'continue_with',
                shape: 'rectangular'
            }
        );
    } else {
        console.error('Google Sign-In library not loaded');
        document.getElementById('googleSignInButton').innerHTML = `
            <button class="social-btn" onclick="alert('Google Sign-In is not available. Please check your internet connection.')">
                <svg width="18" height="18" viewBox="0 0 18 18">
                    <path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.875 2.684-6.615z"/>
                    <path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.184l-2.908-2.258c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9 18z"/>
                    <path fill="#FBBC05" d="M3.964 10.707c-.18-.54-.282-1.117-.282-1.707 0-.593.102-1.17.282-1.709V4.958H.957C.347 6.173 0 7.548 0 9c0 1.452.348 2.827.957 4.042l3.007-2.335z"/>
                    <path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29C4.672 5.163 6.656 3.58 9 3.58z"/>
                </svg>
                Continue with Google
            </button>
        `;
    }
}

// Handle email login (also sends welcome email for first-time users)
async function handleLogin(event) {
    event.preventDefault();
    const email = event.target.querySelector('input[type="email"]').value;
    const name = email.split('@')[0];
    const isFirstTime = isFirstTimeLogin(email);

    const userData = {
        email: email,
        name: name,
        provider: 'email',
        loginTime: new Date().toISOString(),
        isFirstLogin: isFirstTime
    };
    localStorage.setItem('vastr_user', JSON.stringify(userData));

    // Send welcome email only for first-time users
    if (isFirstTime) {
        try {
            await fetch(`${API_BASE}/auth/welcome-email`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    name: name,
                    website_url: window.location.origin
                })
            });
            showNotification('Welcome! Check your email for a special message.');
            markUserLogin(email);
        } catch (error) {
            console.error('Email sending failed:', error);
            showNotification('Welcome!');
        }
    } else {
        showNotification('Welcome back!');
    }

    closeAuthModal();
    updateProfileUI();
    updateWishlistCount();

    const redirect = localStorage.getItem('redirect_after_login');
    if (redirect) {
        localStorage.removeItem('redirect_after_login');
        if (redirect === 'wishlist.html') {
            window.location.href = 'wishlist.html';
        }
    }
}

// Logout function
function logout(event) {
    event.preventDefault();
    if (confirm('Are you sure you want to log out?')) {
        localStorage.removeItem('vastr_user');
        localStorage.removeItem('vastr_wishlist');
        // Don't remove login history - we want to track this

        showNotification('Logged out successfully');
        updateProfileUI();
        updateWishlistCount();
        updateHeartIcons();
        document.getElementById('profileDropdown').classList.remove('active');
    }
}
function createAuthModal() {
    const modalHTML = `
        <div class="modal" id="authModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeAuthModal()">&times;</button>
                <h2>Welcome to Vastr</h2>
                <p style="color: #666; margin-bottom: 2rem; font-size: 0.95rem;">Sign in to save your wishlist and track orders</p>

                <form class="auth-form" onsubmit="handleLogin(event)">
                    <input type="email" placeholder="Enter your email address" required>
                    <button type="submit">Continue with Email</button>
                </form>

                <div class="auth-divider">OR</div>

                <!-- Google Sign-In Button Container -->
                <div id="googleSignInButton"></div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    document.getElementById('authModal').addEventListener('click', (e) => {
        if (e.target.id === 'authModal') closeAuthModal();
    });

    // Initialize Google Sign-In button
    initializeGoogleSignIn();
}


            // ==================== PROFILE FUNCTIONALITY ====================

// Update profile UI based on login status
function updateProfileUI() {
  const isLoggedInUser = isLoggedIn();
  const profileDropdown = document.getElementById('profileDropdown');
  const userIndicator = document.getElementById('userIndicator');
  const profileMenu = document.getElementById('profileMenu');
  const profileUserInfo = document.getElementById('profileUserInfo');

  if (isLoggedInUser) {
    // Show logged in state
    userIndicator.classList.add('active');
    profileUserInfo.style.display = 'block';
    updateProfileUserInfo();
  } else {
    // Show logged out state
    userIndicator.classList.remove('active');
    profileUserInfo.style.display = 'none';
  }

  updateWishlistCount(); // Also update wishlist count
}

// Update user info in profile dropdown
function updateProfileUserInfo() {
  const user = getUserData();
  if (user) {
    document.getElementById('profileUserName').textContent = user.name || 'User';
    document.getElementById('profileUserEmail').textContent = user.email;

    // Update avatar with initials
    const initials = (user.name || user.email.split('@')[0])
      .split(' ')
      .map(n => n[0])
      .join('')
      .toUpperCase();
    document.getElementById('profileAvatar').textContent = initials;
  }
}

// Profile dropdown toggle
function toggleProfileDropdown() {
  const profileDropdown = document.getElementById('profileDropdown');
  const isActive = profileDropdown.classList.contains('active');

  // Close all other dropdowns
  document.querySelectorAll('.profile-dropdown').forEach(dd => {
    dd.classList.remove('active');
  });

  if (!isActive) {
    profileDropdown.classList.add('active');
  }
}

// Close profile dropdown when clicking outside
document.addEventListener('click', (e) => {
  const profileDropdown = document.getElementById('profileDropdown');
  if (!e.target.closest('.profile-dropdown')) {
    profileDropdown.classList.remove('active');
  }
});

// Profile button click handler
document.getElementById('profileDropdown').addEventListener('click', (e) => {
  e.stopPropagation();
  if (isLoggedIn()) {
    toggleProfileDropdown();
  } else {
    handleProfileClick();
  }
});

// Handle profile icon click
function handleProfileClick() {
  if (!isLoggedIn()) {
    showAuthModal();
    // Set redirect to show profile after login
    localStorage.setItem('redirect_after_login', 'profile');
  } else {
    toggleProfileDropdown();
  }
}

function showAccountSettings(event) {
  event.preventDefault();
  showNotification('Account settings coming soon!');
  document.getElementById('profileDropdown').classList.remove('active');
}

// Placeholder functions for profile menu items
function showOrders(event) {
  event.preventDefault();
  showNotification('Orders feature coming soon!');
  document.getElementById('profileDropdown').classList.remove('active');
}



// Get user data function
function getUserData() {
  const userData = localStorage.getItem('vastr_user');
  return userData ? JSON.parse(userData) : null;
}

// Update handleWishlistClick to use updated UI
// Make sure this is updated in handleWishlistClick
function handleWishlistClick() {
  if (!isLoggedIn()) {
    showAuthModal();
    localStorage.setItem('redirect_after_login', 'wishlist.html');
  } else {
    window.location.href = 'wishlist.html';
  }
}
// Add these functions to your script section
async function loadBrands() {
    loadBrandsWithLogos(); // Use the existing function
}

// Fix the DOMContentLoaded event listener
document.addEventListener('DOMContentLoaded', () => {
    loadProducts();
    updateProfileUI();
    updateWishlistCount();
});

    </script>



</body>
</html>
